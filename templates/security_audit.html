{% extends "base.html" %}

{% block title %}Security Audit - FHE Data Flow{% endblock %}

{% block extra_css %}
<style>
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        margin: 0;
        padding: 0;
    }

    .audit-container {
        max-width: 100%;
        margin: 0;
        padding: 20px;
        min-height: 100vh;
    }

    .audit-header {
        background: white;
        border-radius: 15px;
        padding: 30px;
        margin-bottom: 20px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        text-align: center;
    }

    .audit-header h1 {
        margin: 0 0 10px 0;
        color: #667eea;
        font-size: 2.5em;
    }

    .audit-header p {
        margin: 0;
        color: #666;
        font-size: 1.1em;
    }

    .split-view-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
    }

    .view-panel {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        min-height: 600px;
        max-height: 800px;
        overflow-y: auto;
    }

    .view-panel h2 {
        margin: 0 0 20px 0;
        padding-bottom: 15px;
        border-bottom: 3px solid #667eea;
        font-size: 1.8em;
    }

    .client-view h2 {
        color: #2ecc71;
    }

    .client-view h2::before {
        content: "üë§ ";
    }

    .server-view h2 {
        color: #e74c3c;
    }

    .server-view h2::before {
        content: "üñ•Ô∏è ";
    }

    .event-item {
        background: #f8f9fa;
        border-left: 4px solid #667eea;
        padding: 15px;
        margin-bottom: 15px;
        border-radius: 8px;
        transition: all 0.3s ease;
    }

    .event-item:hover {
        transform: translateX(5px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .event-item.client-event {
        border-left-color: #2ecc71;
        background: #e8f8f5;
    }

    .event-item.server-event {
        border-left-color: #e74c3c;
        background: #fadbd8;
    }

    .event-timestamp {
        font-size: 0.85em;
        color: #999;
        margin-bottom: 8px;
    }

    .event-type {
        font-weight: bold;
        font-size: 1.1em;
        margin-bottom: 10px;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .event-type.key-gen { color: #f39c12; }
    .event-type.encryption { color: #2ecc71; }
    .event-type.server-received { color: #e74c3c; }
    .event-type.inference { color: #9b59b6; }
    .event-type.response { color: #3498db; }
    .event-type.decryption { color: #16a085; }

    .event-data {
        font-family: 'Courier New', monospace;
        font-size: 0.9em;
        background: white;
        padding: 10px;
        border-radius: 5px;
        margin-top: 10px;
        max-height: 200px;
        overflow-y: auto;
    }

    .data-row {
        margin: 5px 0;
        padding: 3px 0;
    }

    .data-label {
        font-weight: bold;
        color: #555;
        display: inline-block;
        min-width: 150px;
    }

    .data-value {
        color: #333;
    }

    .encrypted-data {
        color: #e74c3c;
        font-weight: bold;
        word-break: break-all;
    }

    .plaintext-data {
        color: #2ecc71;
        font-weight: bold;
    }

    .privacy-badge {
        display: inline-block;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.85em;
        font-weight: bold;
        margin: 5px 5px 5px 0;
    }

    .badge-secure {
        background: #2ecc71;
        color: white;
    }

    .badge-encrypted {
        background: #e74c3c;
        color: white;
    }

    .badge-warning {
        background: #f39c12;
        color: white;
    }

    .timeline-container {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        margin-bottom: 20px;
    }

    .timeline-container h2 {
        margin: 0 0 20px 0;
        color: #667eea;
        font-size: 1.8em;
    }

    .timeline {
        position: relative;
        padding-left: 40px;
    }

    .timeline::before {
        content: '';
        position: absolute;
        left: 15px;
        top: 0;
        bottom: 0;
        width: 3px;
        background: linear-gradient(to bottom, #2ecc71, #e74c3c, #2ecc71);
    }

    .timeline-item {
        position: relative;
        margin-bottom: 30px;
    }

    .timeline-item::before {
        content: '';
        position: absolute;
        left: -32px;
        top: 5px;
        width: 15px;
        height: 15px;
        border-radius: 50%;
        background: #667eea;
        border: 3px solid white;
        box-shadow: 0 0 0 3px #667eea;
    }

    .timeline-content {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
    }

    .controls {
        background: white;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        display: flex;
        gap: 15px;
        align-items: center;
        justify-content: center;
    }

    .btn {
        padding: 12px 25px;
        border: none;
        border-radius: 8px;
        font-size: 1em;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
        background: #95a5a6;
        color: white;
    }

    .btn-secondary:hover {
        background: #7f8c8d;
    }

    .btn-danger {
        background: #e74c3c;
        color: white;
    }

    .btn-danger:hover {
        background: #c0392b;
    }

    .stats-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }

    .stat-card {
        background: white;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        text-align: center;
    }

    .stat-value {
        font-size: 2.5em;
        font-weight: bold;
        color: #667eea;
        margin: 10px 0;
    }

    .stat-label {
        color: #666;
        font-size: 0.9em;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .loading {
        text-align: center;
        padding: 40px;
        color: #999;
        font-style: italic;
    }

    .no-events {
        text-align: center;
        padding: 60px 20px;
        color: #999;
        font-size: 1.2em;
    }

    .no-events::before {
        content: "üì≠";
        display: block;
        font-size: 4em;
        margin-bottom: 20px;
    }

    /* Scrollbar styling */
    .view-panel::-webkit-scrollbar,
    .event-data::-webkit-scrollbar {
        width: 8px;
    }

    .view-panel::-webkit-scrollbar-track,
    .event-data::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }

    .view-panel::-webkit-scrollbar-thumb,
    .event-data::-webkit-scrollbar-thumb {
        background: #667eea;
        border-radius: 10px;
    }

    .view-panel::-webkit-scrollbar-thumb:hover,
    .event-data::-webkit-scrollbar-thumb:hover {
        background: #764ba2;
    }

    /* Animation for new events */
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateX(-20px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    .event-item.new {
        animation: slideIn 0.5s ease;
    }

    /* Responsive design */
    @media (max-width: 1200px) {
        .split-view-container {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="audit-container">
    <div class="audit-header">
        <h1>üîê FHE Security Audit Dashboard</h1>
        <p>Real-time monitoring of encrypted data flow and privacy guarantees</p>
    </div>

    <div class="controls">
        <button class="btn btn-primary" onclick="refreshEvents()">
            üîÑ Refresh Events
        </button>
        <button class="btn btn-secondary" onclick="exportEvents()">
            üíæ Export Log
        </button>
        <button class="btn btn-danger" onclick="clearEvents()">
            üóëÔ∏è Clear Events
        </button>
        <label style="margin-left: auto;">
            <input type="checkbox" id="autoRefresh" checked> Auto-refresh (5s)
        </label>
    </div>

    <div class="stats-container">
        <div class="stat-card">
            <div class="stat-label">Total Events</div>
            <div class="stat-value" id="totalEvents">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Key Generations</div>
            <div class="stat-value" id="keyGenCount">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Encryptions</div>
            <div class="stat-value" id="encryptionCount">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">FHE Inferences</div>
            <div class="stat-value" id="inferenceCount">0</div>
        </div>
    </div>

    <div class="split-view-container">
        <div class="view-panel client-view">
            <h2>Client Side (Plaintext Access)</h2>
            <div id="clientEvents">
                <div class="loading">Waiting for events...</div>
            </div>
        </div>

        <div class="view-panel server-view">
            <h2>Server Side (Encrypted Only)</h2>
            <div id="serverEvents">
                <div class="loading">Waiting for events...</div>
            </div>
        </div>
    </div>

    <div class="timeline-container">
        <h2>üìä Complete Data Flow Timeline</h2>
        <div class="timeline" id="timeline">
            <div class="loading">Waiting for events...</div>
        </div>
    </div>
</div>

<script>
let lastEventCount = 0;
let autoRefreshInterval = null;

// Event type icons and colors
const eventConfig = {
    'KEY_GENERATION': { icon: 'üîë', color: '#f39c12', label: 'Key Generation' },
    'ENCRYPTION': { icon: 'üîê', color: '#2ecc71', label: 'Encryption' },
    'SERVER_RECEIVED': { icon: 'üì•', color: '#e74c3c', label: 'Server Received' },
    'FHE_INFERENCE': { icon: '‚öôÔ∏è', color: '#9b59b6', label: 'FHE Inference' },
    'SERVER_RESPONSE': { icon: 'üì§', color: '#3498db', label: 'Server Response' },
    'DECRYPTION': { icon: 'üîì', color: '#16a085', label: 'Decryption' },
    'DATA_FLOW': { icon: 'üìä', color: '#34495e', label: 'Data Flow' },
    'PRIVACY_CHECK': { icon: 'üõ°Ô∏è', color: '#27ae60', label: 'Privacy Check' },
    'PERFORMANCE_METRICS': { icon: 'üìà', color: '#e67e22', label: 'Performance' }
};

// Client-side events (can see plaintext)
const clientEvents = ['KEY_GENERATION', 'ENCRYPTION', 'DECRYPTION', 'PRIVACY_CHECK'];

// Server-side events (only encrypted data)
const serverEvents = ['SERVER_RECEIVED', 'FHE_INFERENCE', 'SERVER_RESPONSE'];

function formatTimestamp(timestamp) {
    const date = new Date(timestamp);
    return date.toLocaleTimeString() + '.' + date.getMilliseconds();
}

function formatDataValue(key, value) {
    if (typeof value === 'object') {
        return JSON.stringify(value, null, 2);
    }
    if (typeof value === 'number') {
        if (key.includes('time') || key.includes('duration')) {
            return value.toFixed(4) + 's';
        }
        if (key.includes('size')) {
            if (value > 1024 * 1024) {
                return (value / (1024 * 1024)).toFixed(2) + ' MB';
            } else if (value > 1024) {
                return (value / 1024).toFixed(2) + ' KB';
            }
            return value + ' bytes';
        }
    }
    return value;
}

function createEventHTML(event, isClient) {
    const config = eventConfig[event.type] || { icon: 'üìå', color: '#95a5a6', label: event.type };
    const eventClass = isClient ? 'client-event' : 'server-event';
    
    let html = `
        <div class="event-item ${eventClass} new">
            <div class="event-timestamp">${formatTimestamp(event.timestamp)}</div>
            <div class="event-type" style="color: ${config.color}">
                ${config.icon} ${config.label}
            </div>
    `;

    // Add privacy badges
    if (isClient) {
        html += '<span class="privacy-badge badge-secure">‚úÖ Can see plaintext</span>';
    } else {
        html += '<span class="privacy-badge badge-encrypted">üîê Encrypted only</span>';
    }

    // Add event data
    if (event.data && Object.keys(event.data).length > 0) {
        html += '<div class="event-data">';
        
        for (const [key, value] of Object.entries(event.data)) {
            // Skip sensitive data on server side
            if (!isClient && (key.includes('plain') || key === 'decrypted_result')) {
                html += `
                    <div class="data-row">
                        <span class="data-label">${key}:</span>
                        <span class="encrypted-data">‚ùå HIDDEN (Server cannot see)</span>
                    </div>
                `;
                continue;
            }

            // Highlight encrypted data
            const isEncrypted = key.includes('encrypted') || key.includes('eval_keys');
            const valueClass = isEncrypted ? 'encrypted-data' : 'plaintext-data';
            
            let displayValue = formatDataValue(key, value);
            
            // Truncate long strings
            if (typeof displayValue === 'string' && displayValue.length > 100) {
                displayValue = displayValue.substring(0, 100) + '...';
            }

            html += `
                <div class="data-row">
                    <span class="data-label">${key}:</span>
                    <span class="${valueClass}">${displayValue}</span>
                </div>
            `;
        }
        
        html += '</div>';
    }

    html += '</div>';
    return html;
}

function createTimelineHTML(event) {
    const config = eventConfig[event.type] || { icon: 'üìå', color: '#95a5a6', label: event.type };
    
    return `
        <div class="timeline-item">
            <div class="timeline-content">
                <div class="event-timestamp">${formatTimestamp(event.timestamp)}</div>
                <div class="event-type" style="color: ${config.color}">
                    ${config.icon} ${config.label}
                </div>
                ${event.data && event.data.location ? `<div>üìç ${event.data.location}</div>` : ''}
                ${event.data && event.data.duration ? `<div>‚è±Ô∏è ${event.data.duration.toFixed(2)}s</div>` : ''}
            </div>
        </div>
    `;
}

async function refreshEvents() {
    try {
        const response = await fetch('/api/security/events');
        const data = await response.json();
        
        if (!data.events || data.events.length === 0) {
            document.getElementById('clientEvents').innerHTML = '<div class="no-events">No client events yet</div>';
            document.getElementById('serverEvents').innerHTML = '<div class="no-events">No server events yet</div>';
            document.getElementById('timeline').innerHTML = '<div class="no-events">No events yet</div>';
            return;
        }

        // Update stats
        document.getElementById('totalEvents').textContent = data.events.length;
        document.getElementById('keyGenCount').textContent = 
            data.events.filter(e => e.type === 'KEY_GENERATION').length;
        document.getElementById('encryptionCount').textContent = 
            data.events.filter(e => e.type === 'ENCRYPTION').length;
        document.getElementById('inferenceCount').textContent = 
            data.events.filter(e => e.type === 'FHE_INFERENCE').length;

        // Separate client and server events
        const clientEventsList = data.events.filter(e => clientEvents.includes(e.type));
        const serverEventsList = data.events.filter(e => serverEvents.includes(e.type));

        // Update client view
        const clientHTML = clientEventsList.length > 0 
            ? clientEventsList.map(e => createEventHTML(e, true)).join('')
            : '<div class="no-events">No client events yet</div>';
        document.getElementById('clientEvents').innerHTML = clientHTML;

        // Update server view
        const serverHTML = serverEventsList.length > 0
            ? serverEventsList.map(e => createEventHTML(e, false)).join('')
            : '<div class="no-events">No server events yet</div>';
        document.getElementById('serverEvents').innerHTML = serverHTML;

        // Update timeline
        const timelineHTML = data.events.map(e => createTimelineHTML(e)).join('');
        document.getElementById('timeline').innerHTML = timelineHTML;

        // Scroll to bottom if new events
        if (data.events.length > lastEventCount) {
            const clientPanel = document.querySelector('.client-view');
            const serverPanel = document.querySelector('.server-view');
            clientPanel.scrollTop = clientPanel.scrollHeight;
            serverPanel.scrollTop = serverPanel.scrollHeight;
        }

        lastEventCount = data.events.length;

        // Remove 'new' class after animation
        setTimeout(() => {
            document.querySelectorAll('.event-item.new').forEach(el => {
                el.classList.remove('new');
            });
        }, 500);

    } catch (error) {
        console.error('Error fetching events:', error);
    }
}

async function exportEvents() {
    try {
        const response = await fetch('/api/security/export');
        const data = await response.json();
        alert('Events exported to: ' + data.filepath);
    } catch (error) {
        console.error('Error exporting events:', error);
        alert('Error exporting events');
    }
}

async function clearEvents() {
    if (!confirm('Are you sure you want to clear all events?')) {
        return;
    }
    
    try {
        const response = await fetch('/api/security/clear', { method: 'POST' });
        if (response.ok) {
            lastEventCount = 0;
            refreshEvents();
        }
    } catch (error) {
        console.error('Error clearing events:', error);
    }
}

// Auto-refresh setup
document.getElementById('autoRefresh').addEventListener('change', function() {
    if (this.checked) {
        autoRefreshInterval = setInterval(refreshEvents, 5000);
    } else {
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
            autoRefreshInterval = null;
        }
    }
});

// Initial load and start auto-refresh
refreshEvents();
autoRefreshInterval = setInterval(refreshEvents, 5000);

// Cleanup on page unload
window.addEventListener('beforeunload', () => {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
    }
});
</script>
{% endblock %}
